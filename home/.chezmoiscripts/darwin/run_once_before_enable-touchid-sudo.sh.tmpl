{{- if eq .chezmoi.os "darwin" -}}
#!/usr/bin/env bash
# -*- mode: bash; sh-shell: bash -*-
# vim: set ft=bash :

# Enable Touch ID for sudo authentication (works in tmux too)
# This modifies /etc/pam.d/sudo_local to allow Touch ID for sudo commands
# Uses pam_reattach for tmux/screen compatibility
# The sudo_local file survives macOS updates (unlike editing /etc/pam.d/sudo)

TEMPLATE="/etc/pam.d/sudo_local.template"
TARGET="/etc/pam.d/sudo_local"

# Check if template exists (macOS Sonoma+)
if [[ ! -f "$TEMPLATE" ]]; then
  echo "Touch ID sudo template not found (requires macOS Sonoma+), skipping"
  exit 0
fi

# Install pam_reattach for tmux support (if not already installed)
if [[ ! -f "/opt/homebrew/lib/pam/pam_reattach.so" ]]; then
  echo "Installing pam_reattach for tmux Touch ID support..."
  brew install pam-reattach
fi

# Check if already configured with pam_reattach
if [[ -f "$TARGET" ]] && grep -q "pam_reattach" "$TARGET" 2>/dev/null; then
  echo "Touch ID for sudo (with tmux support) already enabled"
  exit 0
fi

echo "Enabling Touch ID for sudo (with tmux support)..."

# Create sudo_local with pam_reattach (for tmux) + pam_tid (for Touch ID)
# Order matters: reattach must come before tid
sudo tee "$TARGET" >/dev/null <<'EOF'
# sudo_local: local config for sudo (survives macOS updates)
# Enable Touch ID for sudo, including in tmux/screen
auth       optional       /opt/homebrew/lib/pam/pam_reattach.so ignore_ssh
auth       sufficient     pam_tid.so
EOF

echo "Touch ID for sudo enabled (works in tmux too)"
{{ end }}
