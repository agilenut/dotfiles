#!/bin/bash
# Install system packages
# This script runs once per machine before dotfiles are applied

set -e

# Helper to print section headers
section() {
  echo ""
  echo "========================================"
  echo "$1"
  echo "========================================"
}

{{ if eq .chezmoi.os "darwin" -}}
# macOS - Install Homebrew and packages

section "Checking Homebrew"

# Install Homebrew if not present
if ! command -v brew &>/dev/null; then
  echo "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  # Add Homebrew to PATH for this script
  if [ -x "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [ -x "/usr/local/bin/brew" ]; then
    eval "$(/usr/local/bin/brew shellenv)"
  fi
else
  echo "Homebrew is already installed"
fi

# Function to install a package if not already installed
# Usage: brew_install <package> [command_name]
# If command_name is provided, checks for that command instead of package name
brew_install() {
  local package="$1"
  local cmd="${2:-$1}"

  # Skip if command already exists (installed via other means)
  if command -v "$cmd" &>/dev/null; then
    echo "  ✓ $package (already available)"
    return 0
  fi

  # Skip if already installed via brew
  if brew list "$package" &>/dev/null; then
    echo "  ✓ $package (installed via brew)"
    return 0
  fi

  echo "  → Installing $package..."
  brew install "$package"
}

section "Terminal Utilities"
brew_install fzf
brew_install fd
brew_install bat
brew_install eza
brew_install zoxide
brew_install tree
brew_install ripgrep
brew_install tmux

section "Shell & Prompt"
brew_install zsh
brew_install pam-reattach # Touch ID in tmux
if ! command -v oh-my-posh &>/dev/null; then
  echo "  → Installing oh-my-posh..."
  brew install --formula jandedobbeleer/oh-my-posh/oh-my-posh
else
  echo "  ✓ oh-my-posh (already installed)"
fi

section "Development Tools"
brew_install neovim nvim
brew_install git
brew_install go
brew_install shellcheck
brew_install shfmt
brew_install git-ignore
brew_install git-credential-manager git-credential-manager-core
brew_install dotnet-sdk dotnet
brew_install powershell pwsh
brew_install chezmoi

section "QuickLook Extensions"
brew_install syntax-highlight
brew_install qlmarkdown

# Function to install a cask if not already installed
# Usage: brew_cask_install <cask> [app_name]
# If app_name is provided, checks for that app instead of deriving from cask name
brew_cask_install() {
  local cask="$1"
  local app="${2:-}"

  # If no app name provided, try common patterns
  if [[ -z "$app" ]]; then
    # Convert cask name to likely app name (e.g., visual-studio-code -> Visual Studio Code)
    app=$(echo "$cask" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1')
  fi

  # Check if app exists in /Applications or ~/Applications
  if [[ -d "/Applications/${app}.app" ]] || [[ -d "${HOME}/Applications/${app}.app" ]]; then
    echo "  ✓ $cask (found ${app}.app)"
    return 0
  fi

  # Skip if already installed via brew
  if brew list --cask "$cask" &>/dev/null; then
    echo "  ✓ $cask (installed via brew)"
    return 0
  fi

  echo "  → Installing $cask..."
  brew install --cask "$cask"
}

section "GUI Applications"
brew_cask_install visual-studio-code "Visual Studio Code"
brew_cask_install warp "Warp"
brew_cask_install alfred "Alfred 5"

section "Browsers"
brew_cask_install firefox "Firefox"
brew_cask_install google-chrome "Google Chrome"

section "Utilities"
brew_cask_install 1password "1Password"
brew_cask_install appcleaner "AppCleaner"
brew_cask_install rectangle-pro "Rectangle Pro"
brew_cask_install logi-options-plus "Logi Options+"

# Virtualization (optional - large download)
# brew_cask_install vmware-fusion

{{ else if eq .chezmoi.os "linux" -}}
# Linux - Detect package manager and install

section "Installing Packages"

if command -v apt &>/dev/null; then
  echo "Using apt..."
  sudo apt update
  sudo apt install -y fzf fd-find bat zoxide tree ripgrep zsh neovim git tmux

  # eza might need a different source on some distros
  if ! command -v eza &>/dev/null; then
    echo "  ⚠ eza not available in apt, skipping..."
  fi
elif command -v pacman &>/dev/null; then
  echo "Using pacman..."
  sudo pacman -S --noconfirm fzf fd bat eza zoxide tree ripgrep zsh neovim git tmux
elif command -v dnf &>/dev/null; then
  echo "Using dnf..."
  sudo dnf install -y fzf fd-find bat eza zoxide tree ripgrep zsh neovim git tmux
fi

{{ end -}}

section "Installation Complete!"
echo ""
echo "Next steps:"
echo "  1. Open a new terminal to load shell configuration"
echo "  2. Run 'dotfiles-test' to verify installation"
echo ""
