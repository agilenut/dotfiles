#!/bin/bash
# Install system packages
# This script runs once per machine before dotfiles are applied

set -e

{{ if eq .chezmoi.os "darwin" -}}
# macOS - Install Homebrew and packages

# Install Homebrew if not present
if ! command -v brew &>/dev/null; then
  echo "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  # Add Homebrew to PATH for this script
  if [ -x "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [ -x "/usr/local/bin/brew" ]; then
    eval "$(/usr/local/bin/brew shellenv)"
  fi
fi

echo "Installing packages via Homebrew..."

# Function to install a package if not already installed
brew_install() {
  if ! brew list "$1" &>/dev/null; then
    echo "Installing $1..."
    brew install "$1"
  else
    echo "$1 is already installed"
  fi
}

# Terminal utilities
brew_install fzf
brew_install fd
brew_install bat
brew_install eza
brew_install zoxide
brew_install tree
brew_install ripgrep

# Shell and prompt
brew_install zsh
if ! command -v oh-my-posh &>/dev/null; then
  echo "Installing oh-my-posh..."
  brew install --formula jandedobbeleer/oh-my-posh/oh-my-posh
else
  echo "oh-my-posh is already installed"
fi

# Development
brew_install neovim
brew_install git
brew_install go
brew_install shellcheck
brew_install shfmt
brew_install git-ignore

# Dotfiles management
brew_install chezmoi

{{ else if eq .chezmoi.os "linux" -}}
# Linux - Detect package manager and install

if command -v apt &>/dev/null; then
  echo "Installing packages via apt..."
  sudo apt update
  sudo apt install -y fzf fd-find bat zoxide tree ripgrep zsh neovim git

  # eza might need a different source on some distros
  if ! command -v eza &>/dev/null; then
    echo "eza not available in apt, skipping..."
  fi
elif command -v pacman &>/dev/null; then
  echo "Installing packages via pacman..."
  sudo pacman -S --noconfirm fzf fd bat eza zoxide tree ripgrep zsh neovim git
elif command -v dnf &>/dev/null; then
  echo "Installing packages via dnf..."
  sudo dnf install -y fzf fd-find bat eza zoxide tree ripgrep zsh neovim git
fi

{{ end -}}

echo "Package installation complete!"
