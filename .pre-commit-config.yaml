# Pre-commit hooks for linting and formatting
# Install: brew install pre-commit && pre-commit install
# Run manually: pre-commit run --all-files

# NOTE: Format and style rules should:
# - Be defined in a single source of truth config file and checked into this repo (use .editorconfig where possible).
# - Use the same underlying tooling across pre-commit hooks,
#   vscode extensions defined in .vscode/extensions.json,
#   and CI tests defined in .github/workflows/test.yml in order to ensure consistency.

repos:
  # Shell formatting (shfmt)
  # Uses .editorconfig for settings (indent_size, binary_next_line, etc.)
  - repo: https://github.com/scop/pre-commit-shfmt
    rev: v3.10.0-1
    hooks:
      - id: shfmt
        # Verbose wrapper that:
        # - Prints "Checking: <file>" for each file
        # - Prints "  Modified: <file>" when a file is reformatted
        # - Lets errors pass through to stderr naturally
        # - Uses --filename with .zsh suffix for extensionless files (dot_zshenv, etc.)
        # - Empty shfmt output means file was ignored via editorconfig
        entry: |
          bash -c '
            rc=0
            for f; do
              echo "Checking: $f"
              fn="$f"
              [[ ! "$f" =~ \.(sh|bash|zsh)$ ]] && fn="${f}.zsh"
              if formatted=$(shfmt --apply-ignore --filename "$fn" < "$f" 2>&1); then
                if [[ -n "$formatted" ]] && ! diff -q <(cat "$f") <(echo "$formatted") >/dev/null 2>&1; then
                  echo "$formatted" > "$f"
                  echo "  Modified: $f"
                fi
              else
                echo "$formatted" >&2
                rc=1
              fi
            done
            exit $rc
          ' _
        args: [] # Override default -w arg
        #verbose: true # Uncomment this if you want verbose logging.
        # Match shell files by extension or executable_ prefix
        types: [text] # Accept any file type
        exclude_types: [] # Override upstream exclusion of zsh
        files: (\.(sh|bash|zsh)$|\.(sh|bash|zsh)\.tmpl$|executable_|zshrc|zshenv|zprofile|zlogin|zlogout)

  # Shell linting (shellcheck) - for bash/sh files only
  # Shellcheck doesn't support zsh, so we exclude zsh-specific files
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.10.0.1
    hooks:
      - id: shellcheck
        # Wrapper prints "Checking: <file>" for each file, then runs shellcheck
        entry: |
          bash -c '
            rc=0
            for f; do
              echo "Checking: $f"
              shellcheck --severity=warning "$f" || rc=1
            done
            exit $rc
          ' _
        args: []
        types: [shell]
        exclude: (\.zsh$)
        #verbose: true # Uncomment to see files checked

  # TOML formatting and linting (taplo)
  # Settings in .taplo.toml (indent_tables, align_entries, etc.)
  - repo: https://github.com/ComPWA/mirrors-taplo
    rev: v0.9.3
    hooks:
      - id: taplo-format
        # Wrapper prints "Checking: <file>" for each file
        entry: |
          bash -c '
            export RUST_LOG=error
            rc=0
            for f; do
              echo "Checking: $f"
              taplo format "$f" || rc=1
            done
            exit $rc
          ' _
        args: []
        types: [text]
        files: \.toml(\.tmpl)?$
        #verbose: true # Uncomment to see files checked
      - id: taplo-lint
        # Wrapper prints "Checking: <file>" for each file
        # Schema validation disabled in .taplo.toml; this checks syntax only
        entry: |
          bash -c '
            export RUST_LOG=error
            rc=0
            for f; do
              echo "Checking: $f"
              taplo lint "$f" || rc=1
            done
            exit $rc
          ' _
        args: []
        types: [text]
        files: \.toml(\.tmpl)?$
        #verbose: true # Uncomment to see files checked

  # Markdown linting (markdownlint-cli)
  # Settings in .markdownlint.yaml
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.43.0
    hooks:
      - id: markdownlint
        # Wrapper that:
        # - Prints "Checking: <file>" for each file (when verbose)
        # - Runs markdownlint --fix to auto-fix issues
        # - Prints "  Modified: <file>" when a file is changed
        # - Fails if any file was modified (so pre-commit knows files changed)
        # - Fails if unfixable errors remain
        entry: |
          bash -c '
            rc=0
            modified=0
            for f; do
              echo "Checking: $f"  # Uncomment for verbose output
              before=$(cat "$f")
              if ! markdownlint --fix "$f" 2>&1; then
                rc=1
              fi
              after=$(cat "$f")
              if [[ "$before" != "$after" ]]; then
                echo "  Modified: $f"
                modified=1
              fi
            done
            [[ $modified -eq 1 ]] && rc=1
            exit $rc
          ' _
        args: []
        types: [markdown]
        verbose: true # Uncomment to see files checked
#
#  # Prettier for general formatting (json, yaml)
#  - repo: https://github.com/pre-commit/mirrors-prettier
#    rev: v4.0.0-alpha.8
#    hooks:
#      - id: prettier
#        types_or: [json, yaml]
#        exclude: \.tmpl$
#
#  # Basic file hygiene
#  - repo: https://github.com/pre-commit/pre-commit-hooks
#    rev: v5.0.0
#    hooks:
#      - id: trailing-whitespace
#        exclude: \.md$
#      - id: end-of-file-fixer
#      - id: check-yaml
#        exclude: \.tmpl$
#      - id: check-toml
#        exclude: \.tmpl$
#      - id: check-merge-conflict
